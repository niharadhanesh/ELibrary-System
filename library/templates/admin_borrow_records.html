{% extends 'base_admin.html' %}

{% block title %}Borrow Records - Admin Panel{% endblock %}

{% block content %}
<style>
  .page-header {
    background: white;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .page-header h1 i {
    font-size: 2.2rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-box {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
  }
  .stat-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
  }
  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
  }
  .stat-icon.borrowed {
    background: linear-gradient(135deg, #667eea, #764ba2);
  }
  .stat-icon.returned {
    background: linear-gradient(135deg, #11998e, #38ef7d);
  }
  .stat-icon.overdue {
    background: linear-gradient(135deg, #f54291, #f5576c);
  }
  .stat-icon.active {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
  }
  .stat-content h3 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #333;
    margin: 0;
  }
  .stat-content p {
    margin: 0;
    color: #888;
    font-size: 0.9rem;
  }
  
  .filter-section {
    background: white;
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
  }
  .filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }
  .filter-item label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 8px;
  }
  .filter-item input,
  .filter-item select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e7ff;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }
  .filter-item input:focus,
  .filter-item select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }
  .filter-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .btn-filter {
    padding: 12px 25px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btn-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }
  .btn-reset {
    padding: 12px 25px;
    background: white;
    border: 2px solid #e0e7ff;
    color: #667eea;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .btn-reset:hover {
    background: #f8f9ff;
    border-color: #667eea;
  }
  
  .records-table-container {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
    overflow: hidden;
  }
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .table-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #333;
    margin: 0;
  }
  .export-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #11998e, #38ef7d);
    border: none;
    color: white;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
  }
  
  .records-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    overflow: hidden;
  }
  .records-table thead {
    background: linear-gradient(135deg, #667eea, #764ba2);
  }
  .records-table thead th {
    padding: 15px;
    text-align: left;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .records-table thead th:first-child {
    border-radius: 12px 0 0 0;
  }
  .records-table thead th:last-child {
    border-radius: 0 12px 0 0;
  }
  .records-table tbody tr {
    border-bottom: 1px solid #f0f4ff;
    transition: all 0.3s ease;
  }
  .records-table tbody tr:hover {
    background: #f8f9ff;
    transform: scale(1.01);
  }
  .records-table tbody td {
    padding: 18px 15px;
    color: #333;
    font-size: 0.9rem;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
  }
  .user-details h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
  }
  .user-details p {
    margin: 0;
    font-size: 0.8rem;
    color: #888;
  }
  
  .book-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .book-cover-mini {
    width: 40px;
    height: 55px;
    border-radius: 6px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .book-cover-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
  .book-details h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
  }
  .book-details p {
    margin: 0;
    font-size: 0.8rem;
    color: #888;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .status-borrowed {
    background: rgba(102, 126, 234, 0.15);
    color: #667eea;
  }
  .status-returned {
    background: rgba(17, 153, 142, 0.15);
    color: #11998e;
  }
  .status-overdue {
    background: rgba(245, 66, 145, 0.15);
    color: #f54291;
  }
  
  .date-info {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  .date-label {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .date-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
  }
  .btn-action {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .btn-view {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    color: white;
  }
  .btn-view:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
  }
  .btn-return {
    background: linear-gradient(135deg, #11998e, #38ef7d);
    color: white;
  }
  .btn-return:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
  }
  .btn-remind {
    background: linear-gradient(135deg, #ffa751, #ffe259);
    color: white;
  }
  .btn-remind:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 167, 81, 0.4);
  }
  
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 30px;
  }
  .pagination {
    display: flex;
    gap: 10px;
    list-style: none;
    padding: 0;
  }
  .pagination .page-link {
    padding: 10px 16px;
    background: white;
    border: 2px solid #e0e7ff;
    color: #667eea;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .pagination .page-link:hover {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
  }
  .pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: transparent;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
  }
  .empty-state i {
    font-size: 4rem;
    color: #e0e7ff;
    margin-bottom: 20px;
  }
  .empty-state h3 {
    color: #333;
    font-size: 1.5rem;
    margin-bottom: 10px;
  }
  .empty-state p {
    color: #888;
    font-size: 1rem;
  }

  .fine-amount {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: rgba(245, 66, 145, 0.1);
    border-radius: 12px;
    font-weight: 600;
    color: #f54291;
    font-size: 0.85rem;
  }
</style>

<!-- Page Header -->
<div class="page-header">
  <h1>
    <i class="bi bi-journal-text"></i>
    Borrow Records Management
  </h1>
</div>

<!-- Statistics Overview -->
<div class="stats-overview">
  <div class="stat-box">
    <div class="stat-icon borrowed">
      <i class="bi bi-book"></i>
    </div>
    <div class="stat-content">
      <h3>{{ total_records }}</h3>
      <p>Total Records</p>
    </div>
  </div>
  
  <div class="stat-box">
    <div class="stat-icon active">
      <i class="bi bi-bookmark-check"></i>
    </div>
    <div class="stat-content">
      <h3>{{ active_borrows }}</h3>
      <p>Currently Borrowed</p>
    </div>
  </div>
  
  <div class="stat-box">
    <div class="stat-icon overdue">
      <i class="bi bi-exclamation-triangle"></i>
    </div>
    <div class="stat-content">
      <h3>{{ overdue_count }}</h3>
      <p>Overdue Books</p>
    </div>
  </div>
  
  <div class="stat-box">
    <div class="stat-icon returned">
      <i class="bi bi-check-circle"></i>
    </div>
    <div class="stat-content">
      <h3>{{ returned_count }}</h3>
      <p>Returned Books</p>
    </div>
  </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
  <form method="GET" action="">
    <div class="filter-row">
      <div class="filter-item">
        <label><i class="bi bi-search me-1"></i>Search User</label>
        <input type="text" name="user_search" placeholder="Name, email, or ID..." value="{{ user_search }}">
      </div>
      
      <div class="filter-item">
        <label><i class="bi bi-book me-1"></i>Search Book</label>
        <input type="text" name="book_search" placeholder="Title, author, or ISBN..." value="{{ book_search }}">
      </div>
      
      <div class="filter-item">
        <label><i class="bi bi-filter me-1"></i>Status</label>
        <select name="status">
          <option value="">All Status</option>
          <option value="borrowed" {% if status == 'borrowed' %}selected{% endif %}>Borrowed</option>
          <option value="overdue" {% if status == 'overdue' %}selected{% endif %}>Overdue</option>
          <option value="returned" {% if status == 'returned' %}selected{% endif %}>Returned</option>
        </select>
      </div>
      
      <div class="filter-item">
        <label><i class="bi bi-sort-down me-1"></i>Sort By</label>
        <select name="sort">
          <option value="-borrow_date" {% if sort == '-borrow_date' %}selected{% endif %}>Newest First</option>
          <option value="borrow_date" {% if sort == 'borrow_date' %}selected{% endif %}>Oldest First</option>
          <option value="due_date" {% if sort == 'due_date' %}selected{% endif %}>Due Date (Ascending)</option>
          <option value="-due_date" {% if sort == '-due_date' %}selected{% endif %}>Due Date (Descending)</option>
          <option value="user__username" {% if sort == 'user__username' %}selected{% endif %}>User (A-Z)</option>
          <option value="book__title" {% if sort == 'book__title' %}selected{% endif %}>Book Title (A-Z)</option>
        </select>
      </div>
    </div>
    
    <div class="filter-actions">
      <a href="{% url 'admin_borrow_records' %}" class="btn-reset">
        <i class="bi bi-arrow-clockwise me-1"></i>Reset
      </a>
      <button type="submit" class="btn-filter">
        <i class="bi bi-funnel"></i>Apply Filters
      </button>
    </div>
  </form>
</div>

<!-- Records Table -->
<div class="records-table-container">
  <div class="table-header">
    <h2>Borrow Records ({{ records.paginator.count }})</h2>
    <button class="export-btn" onclick="exportRecords()">
      <i class="bi bi-download"></i>
      Export to CSV
    </button>
  </div>
  
  {% if records %}
  <div style="overflow-x: auto;">
    <table class="records-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Book</th>
          <th>Borrow Date</th>
          <th>Due Date</th>
          <th>Return Date</th>
          <th>Status</th>
          <th>Fine</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for record in records %}
        <tr>
          <td><strong>#{{ record.id }}</strong></td>
          
          <td>
            <div class="user-info">
              <div class="user-avatar">
                {{ record.user.first_name.0|default:record.user.username.0|upper }}
              </div>
              <div class="user-details">
                <h4>{{ record.user.get_full_name|default:record.user.username }}</h4>
                <p><i class="bi bi-envelope me-1"></i>{{ record.user.email }}</p>
              </div>
            </div>
          </td>
          
          <td>
            <div class="book-info">
              <div class="book-cover-mini">
                {% if record.book.cover_image %}
                  <img src="{{ record.book.cover_image.url }}" alt="{{ record.book.title }}">
                {% else %}
                  <i class="bi bi-book"></i>
                {% endif %}
              </div>
              <div class="book-details">
                <h4>{{ record.book.title|truncatewords:5 }}</h4>
                <p><i class="bi bi-person me-1"></i>{{ record.book.author }}</p>
              </div>
            </div>
          </td>
          
          <td>
            <div class="date-info">
              <span class="date-label">Borrowed</span>
              <span class="date-value">{{ record.borrow_date|date:"M d, Y" }}</span>
            </div>
          </td>
          
          <td>
            <div class="date-info">
              <span class="date-label">Due</span>
              <span class="date-value">{{ record.due_date|date:"M d, Y" }}</span>
            </div>
          </td>
          
          <td>
            {% if record.return_date %}
              <div class="date-info">
                <span class="date-label">Returned</span>
                <span class="date-value">{{ record.return_date|date:"M d, Y" }}</span>
              </div>
            {% else %}
              <span style="color: #999; font-style: italic;">â€”</span>
            {% endif %}
          </td>
          
          <td>
            {% if record.status == 'borrowed' %}
              <span class="status-badge status-borrowed">
                <i class="bi bi-bookmark"></i>Borrowed
              </span>
            {% elif record.status == 'overdue' %}
              <span class="status-badge status-overdue">
                <i class="bi bi-exclamation-circle"></i>Overdue
              </span>
            {% elif record.status == 'returned' %}
              <span class="status-badge status-returned">
                <i class="bi bi-check-circle"></i>Returned
              </span>
            {% endif %}
          </td>
          
          <td>
            {% if record.fine_amount and record.fine_amount > 0 %}
              <span class="fine-amount">
                <i class="bi bi-currency-dollar"></i>{{ record.fine_amount }}
              </span>
            {% else %}
              <span style="color: #11998e; font-weight: 600;">$0.00</span>
            {% endif %}
          </td>
          
          <td>
            <div class="action-buttons">
              <button class="btn-action btn-view"
        data-bs-toggle="modal"
        data-bs-target="#recordDetailsModal"
        data-id="{{ record.id }}"
        data-user="{{ record.user.get_full_name|default:record.user.username }}"
        data-email="{{ record.user.email }}"
        data-book="{{ record.book.title }}"
        data-author="{{ record.book.author }}"
        data-borrow="{{ record.borrow_date|date:'M d, Y' }}"
        data-due="{{ record.due_date|date:'M d, Y' }}"
        data-return="{{ record.return_date|date:'M d, Y'|default:'Not returned' }}"
        data-status="{{ record.status }}"
        data-fine="{{ record.fine_amount|default:'0.00' }}"
        title="View Details">
       <i class="bi bi-eye"></i>
      </button>

              
              {% if record.status in 'borrowed,overdue' %}
                <button class="btn-action btn-return" onclick="processReturn({{ record.id }})" title="Process Return">
                  <i class="bi bi-arrow-return-left"></i>
                </button>
              {% endif %}
              
              {% if record.status == 'overdue' %}
                <button class="btn-action btn-remind" onclick="sendReminder({{ record.id }})" title="Send Reminder">
                  <i class="bi bi-bell"></i>
                </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  {% if records.has_other_pages %}
  <div class="pagination-container">
    <ul class="pagination">
      {% if records.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ records.previous_page_number }}{% if user_search %}&user_search={{ user_search }}{% endif %}{% if book_search %}&book_search={{ book_search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
            <i class="bi bi-chevron-left"></i>
          </a>
        </li>
      {% endif %}
      
      {% for num in records.paginator.page_range %}
        {% if num == records.number %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > records.number|add:'-3' and num < records.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if user_search %}&user_search={{ user_search }}{% endif %}{% if book_search %}&book_search={{ book_search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
              {{ num }}
            </a>
          </li>
        {% endif %}
      {% endfor %}
      
      {% if records.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ records.next_page_number }}{% if user_search %}&user_search={{ user_search }}{% endif %}{% if book_search %}&book_search={{ book_search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">
            <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      {% endif %}
    </ul>
  </div>
  {% endif %}
  
  {% else %}
  <div class="empty-state">
    <i class="bi bi-inbox"></i>
    <h3>No Records Found</h3>
    <p>No borrow records match your current filters. Try adjusting your search criteria.</p>
  </div>
  {% endif %}
</div>


<!-- Record Details Modal -->
<div class="modal fade" id="recordDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">

      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 25px 30px;">
        <h5 class="modal-title" style="color: white; font-size: 24px; font-weight: 600; display: flex; align-items: center; margin: 0;">
          <i class="bi bi-info-circle me-2"></i>Borrow Record Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" style="background: rgba(255, 255, 255, 0.3); opacity: 1; border-radius: 50%; width: 35px; height: 35px; background-image: none; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.5)'; this.style.transform='rotate(90deg)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='rotate(0deg)';">
          <span style="color: white; font-size: 24px; font-weight: 300;">&times;</span>
        </button>
      </div>

      <div class="modal-body" style="padding: 30px; background: #ffffff;">
        <div class="details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          
          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
            <p style="margin: 0; font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-person-circle" style="margin-right: 6px;"></i>User
            </p>
            <p style="margin: 0; font-size: 16px; color: #2d3748; font-weight: 600;" id="modalUser"></p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
            <p style="margin: 0; font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-envelope" style="margin-right: 6px;"></i>Email
            </p>
            <p style="margin: 0; font-size: 14px; color: #2d3748; font-weight: 500; word-break: break-all;" id="modalEmail"></p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #764ba2;">
            <p style="margin: 0; font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-book" style="margin-right: 6px;"></i>Book
            </p>
            <p style="margin: 0; font-size: 16px; color: #2d3748; font-weight: 600;" id="modalBook"></p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #764ba2;">
            <p style="margin: 0; font-size: 12px; color: #718096; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-person" style="margin-right: 6px;"></i>Author
            </p>
            <p style="margin: 0; font-size: 14px; color: #2d3748; font-weight: 500;" id="modalAuthor"></p>
          </div>

          <div style="background: #e6fffa; padding: 20px; border-radius: 12px; border-left: 4px solid #047857;">
            <p style="margin: 0; font-size: 12px; color: #047857; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-calendar-plus" style="margin-right: 6px;"></i>Borrow Date
            </p>
            <p style="margin: 0; font-size: 16px; color: #2d3748; font-weight: 600;" id="modalBorrow"></p>
          </div>

          <div style="background: #dbeafe; padding: 20px; border-radius: 12px; border-left: 4px solid #1e40af;">
            <p style="margin: 0; font-size: 12px; color: #1e40af; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-calendar-check" style="margin-right: 6px;"></i>Due Date
            </p>
            <p style="margin: 0; font-size: 16px; color: #2d3748; font-weight: 600;" id="modalDue"></p>
          </div>

          <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border-left: 4px solid #92400e;">
            <p style="margin: 0; font-size: 12px; color: #92400e; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-calendar-x" style="margin-right: 6px;"></i>Return Date
            </p>
            <p style="margin: 0; font-size: 16px; color: #2d3748; font-weight: 600;" id="modalReturn"></p>
          </div>

          <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 12px; border: 2px solid #667eea;">
            <p style="margin: 0; font-size: 12px; color: #667eea; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-flag" style="margin-right: 6px;"></i>Status
            </p>
            <span id="modalStatus" class="badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;"></span>
          </div>

          <div style="background: #fed7d7; padding: 20px; border-radius: 12px; border-left: 4px solid #e53e3e; grid-column: span 2;">
            <p style="margin: 0; font-size: 12px; color: #c53030; text-transform: uppercase; font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-currency-dollar" style="margin-right: 6px;"></i>Fine Amount
            </p>
            <p style="margin: 0; font-size: 28px; color: #e53e3e; font-weight: 700;">
              $<span id="modalFine"></span>
            </p>
          </div>

        </div>
      </div>

      <div class="modal-footer" style="border-top: 1px solid #e2e8f0; padding: 20px 30px; background: #f7fafc;">
        <button class="btn btn-secondary" data-bs-dismiss="modal" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; color: white; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
      </div>

    </div>
  </div>
</div>

<script>
function viewDetails(recordId) {
  // Example data - replace with your actual data fetching logic
  const recordData = {
    user: 'John Smith',
    email: 'john.smith@email.com',
    book: 'The Great Gatsby',
    author: 'F. Scott Fitzgerald',
    borrowDate: 'Dec 15, 2024',
    dueDate: 'Jan 15, 2025',
    returnDate: 'Not returned yet',
    status: 'overdue',
    fine: '15.50'
  };

  // Populate modal fields
  document.getElementById('modalUser').textContent = recordData.user;
  document.getElementById('modalEmail').textContent = recordData.email;
  document.getElementById('modalBook').textContent = recordData.book;
  document.getElementById('modalAuthor').textContent = recordData.author;
  document.getElementById('modalBorrow').textContent = recordData.borrowDate;
  document.getElementById('modalDue').textContent = recordData.dueDate;
  document.getElementById('modalReturn').textContent = recordData.returnDate;
  document.getElementById('modalFine').textContent = recordData.fine;

  // Set status badge with appropriate styling
  const statusBadge = document.getElementById('modalStatus');
  statusBadge.innerHTML = '';
  
  if (recordData.status === 'borrowed') {
    statusBadge.style.background = '#bee3f8';
    statusBadge.style.color = '#2c5282';
    statusBadge.innerHTML = '<i class="bi bi-bookmark"></i>Borrowed';
  } else if (recordData.status === 'overdue') {
    statusBadge.style.background = '#fed7d7';
    statusBadge.style.color = '#c53030';
    statusBadge.innerHTML = '<i class="bi bi-exclamation-circle"></i>Overdue';
  } else if (recordData.status === 'returned') {
    statusBadge.style.background = '#c6f6d5';
    statusBadge.style.color = '#22543d';
    statusBadge.innerHTML = '<i class="bi bi-check-circle"></i>Returned';
  }

  // Change fine amount color if zero
  const fineElement = document.getElementById('modalFine').parentElement;
  if (parseFloat(recordData.fine) === 0) {
    fineElement.style.color = '#11998e';
  } else {
    fineElement.style.color = '#e53e3e';
  }

  // Show modal (requires Bootstrap JS)
  const modal = new bootstrap.Modal(document.getElementById('recordDetailsModal'));
  modal.show();
}
</script>

<script>
document.getElementById('recordDetailsModal').addEventListener('show.bs.modal', function (event) {
  const button = event.relatedTarget;

  document.getElementById('modalUser').textContent   = button.getAttribute('data-user');
  document.getElementById('modalEmail').textContent  = button.getAttribute('data-email');
  document.getElementById('modalBook').textContent   = button.getAttribute('data-book');
  document.getElementById('modalAuthor').textContent = button.getAttribute('data-author');
  document.getElementById('modalBorrow').textContent = button.getAttribute('data-borrow');
  document.getElementById('modalDue').textContent    = button.getAttribute('data-due');
  document.getElementById('modalReturn').textContent = button.getAttribute('data-return');
  document.getElementById('modalFine').textContent   = button.getAttribute('data-fine');

  const status = button.getAttribute('data-status');
  const statusEl = document.getElementById('modalStatus');

  statusEl.textContent = status.toUpperCase();
  statusEl.className = 'badge';

  if (status === 'borrowed') statusEl.classList.add('bg-primary');
  else if (status === 'overdue') statusEl.classList.add('bg-danger');
  else if (status === 'returned') statusEl.classList.add('bg-success');
});
</script>

<script>
function viewDetails(recordId) {
  window.location.href = `/admin/borrow-record/${recordId}/`;
}

function processReturn(recordId) {
  if (confirm('Process return for this book? This will update the book availability and calculate any applicable fines.')) {
    fetch(`/admin/borrow-record/${recordId}/return/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.message || 'Failed to process return');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  }
}

function sendReminder(recordId) {
  if (confirm('Send overdue reminder email to the user?')) {
    fetch(`/admin/borrow-record/${recordId}/remind/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
      } else {
        alert(data.message || 'Failed to send reminder');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  }
}

function exportRecords() {
  const params = new URLSearchParams(window.location.search);
  params.set('export', 'csv');
  window.location.href = `${window.location.pathname}?${params.toString()}`;
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}